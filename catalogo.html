<script>
// --- Datos de países, idiomas y monedas (usa tu countriesData ya integrado) ---
const countriesData = [...]; // Usa el mismo array completo que ya tienes
const languageNames = {...}; // Usa tu objeto completo

// --- Llenar selectores de país, idioma y moneda ---
const countrySelect = document.getElementById("country");
const languageSelect = document.getElementById("language");
const currencySelect = document.getElementById("currency");

countriesData.forEach(country => {
  if (!countrySelect.querySelector(option[value="${country.code}"])) {
    countrySelect.innerHTML += <option value="${country.code}">${country.name}</option>;
  }

  if (!languageSelect.querySelector(option[value="${country.language}"])) {
    const langName = languageNames[country.language] || country.language;
    languageSelect.innerHTML += <option value="${country.language}">${langName}</option>;
  }

  if (!currencySelect.querySelector(option[value='${country.currency}'])) {
    currencySelect.innerHTML += <option value="${country.currency}">${country.currency}</option>;
  }
});

// --- Aplicar traducción al catálogo ---
const translations = {
  es: {
    "Inicio": "Inicio",
    "Catálogo": "Catálogo",
    "Registrarse": "Registrarse",
    "Iniciar Sesión": "Iniciar Sesión",
    "Contacto": "Contacto",
    "Agregar al carrito": "Agregar al carrito",
    "Tu librería digital inteligente e internacional": "Tu librería digital inteligente e internacional"
  },
  en: {
    "Inicio": "Home",
    "Catálogo": "Catalog",
    "Registrarse": "Register",
    "Iniciar Sesión": "Login",
    "Contacto": "Contact",
    "Agregar al carrito": "Add to cart",
    "Tu librería digital inteligente e internacional": "Your smart and international digital bookstore"
  },
  fr: {
    "Inicio": "Accueil",
    "Catálogo": "Catalogue",
    "Registrarse": "S'inscrire",
    "Iniciar Sesión": "Connexion",
    "Contacto": "Contact",
    "Agregar al carrito": "Ajouter au panier",
    "Tu librería digital inteligente e internacional": "Votre librairie numérique intelligente et internationale"
  },
  // Puedes agregar más idiomas
};

function aplicarTraduccion() {
  const lang = localStorage.getItem('language') || 'es';
  const dict = translations[lang];
  if (!dict) return;

  document.querySelectorAll("nav a, .carrito-btn, header p").forEach(el => {
    if (dict[el.textContent]) {
      el.textContent = dict[el.textContent];
    }
  });
}

// --- Actualizar precios según moneda ---
function updatePrices(symbol) {
  const prices = document.querySelectorAll(".price");
  prices.forEach(el => {
    const base = el.getAttribute("data-base");
    el.textContent = ${symbol} ${base};
  });
}

// --- Cambios de país manual ---
countrySelect.onchange = () => {
  const country = countrySelect.value;
  const selected = countriesData.find(c => c.code === country);
  languageSelect.value = selected.language;
  currencySelect.value = selected.currency;
  localStorage.setItem('country', country);
  localStorage.setItem('language', selected.language);
  localStorage.setItem('currency', selected.currency);
  updatePrices(selected.currency);
  aplicarTraduccion();
};

// --- Cambio de idioma manual ---
languageSelect.onchange = () => {
  localStorage.setItem('language', languageSelect.value);
  aplicarTraduccion();
};

// --- Cambio de moneda manual ---
currencySelect.onchange = () => {
  localStorage.setItem('currency', currencySelect.value);
  updatePrices(currencySelect.value);
};

// --- Detectar IP si no hay datos guardados ---
if (!localStorage.getItem("country")) {
  fetch("https://ipapi.co/json/")
    .then(response => response.json())
    .then(data => {
      const countryCode = data.country_code || "CO";
      const countryData = countriesData.find(c => c.code === countryCode);
      if (countryData) {
        localStorage.setItem("country", countryData.code);
        localStorage.setItem("language", countryData.language);
        localStorage.setItem("currency", countryData.currency);
      }
    })
    .catch(err => console.error("Error al detectar país por IP:", err));
}

// --- Cargar preferencias guardadas al cargar página ---
window.onload = () => {
  const savedCountry = localStorage.getItem("country") || "CO";
  const savedLanguage = localStorage.getItem("language") || "es";
  const savedCurrency = localStorage.getItem("currency") || "COP $";

  countrySelect.value = savedCountry;
  languageSelect.value = savedLanguage;
  currencySelect.value = savedCurrency;

  updatePrices(savedCurrency);
  aplicarTraduccion();
};
</script>
